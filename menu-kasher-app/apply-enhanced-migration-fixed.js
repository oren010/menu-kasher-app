// Script pour appliquer la migration vers le sch√©ma avanc√©
const { PrismaClient } = require('@prisma/client');

const prisma = new PrismaClient();

async function applyEnhancedMigration() {
  console.log("üîÑ D√©but de l'application de la migration avanc√©e...");
  
  try {
    // √âtape 1: Ajouter les nouvelles colonnes avec valeurs par d√©faut
    console.log("üìù √âtape 1: Ajout des nouvelles colonnes...");
    
    // 1. Extension du mod√®le User
    await prisma.$executeRaw`ALTER TABLE "users" ADD COLUMN IF NOT EXISTS "adultsCount" INTEGER DEFAULT 2`;
    await prisma.$executeRaw`ALTER TABLE "users" ADD COLUMN IF NOT EXISTS "dietaryRestrictions" TEXT[] DEFAULT ARRAY[]::TEXT[]`;
    await prisma.$executeRaw`ALTER TABLE "users" ADD COLUMN IF NOT EXISTS "allergens" TEXT[] DEFAULT ARRAY[]::TEXT[]`;
    await prisma.$executeRaw`ALTER TABLE "users" ADD COLUMN IF NOT EXISTS "excludedIngredients" TEXT[] DEFAULT ARRAY[]::TEXT[]`;
    await prisma.$executeRaw`ALTER TABLE "users" ADD COLUMN IF NOT EXISTS "includeLunch" BOOLEAN DEFAULT true`;
    await prisma.$executeRaw`ALTER TABLE "users" ADD COLUMN IF NOT EXISTS "includeDinner" BOOLEAN DEFAULT true`;
    await prisma.$executeRaw`ALTER TABLE "users" ADD COLUMN IF NOT EXISTS "includeAdultMeals" BOOLEAN DEFAULT true`;
    await prisma.$executeRaw`ALTER TABLE "users" ADD COLUMN IF NOT EXISTS "includeChildMeals" BOOLEAN DEFAULT true`;
    await prisma.$executeRaw`ALTER TABLE "users" ADD COLUMN IF NOT EXISTS "cookingSkillLevel" TEXT DEFAULT 'intermediate'`;
    await prisma.$executeRaw`ALTER TABLE "users" ADD COLUMN IF NOT EXISTS "preferredDifficulty" TEXT DEFAULT 'medium'`;
    await prisma.$executeRaw`ALTER TABLE "users" ADD COLUMN IF NOT EXISTS "dietGoal" TEXT`;
    await prisma.$executeRaw`ALTER TABLE "users" ADD COLUMN IF NOT EXISTS "currentWeight" DOUBLE PRECISION`;
    await prisma.$executeRaw`ALTER TABLE "users" ADD COLUMN IF NOT EXISTS "targetWeight" DOUBLE PRECISION`;
    await prisma.$executeRaw`ALTER TABLE "users" ADD COLUMN IF NOT EXISTS "dailyCalorieTarget" INTEGER`;
    await prisma.$executeRaw`ALTER TABLE "users" ADD COLUMN IF NOT EXISTS "weeklyRefinedMeals" INTEGER DEFAULT 2`;
    await prisma.$executeRaw`ALTER TABLE "users" ADD COLUMN IF NOT EXISTS "budgetLevel" TEXT DEFAULT 'medium'`;
    
    console.log("  ‚úÖ Colonnes utilisateur ajout√©es");
    
    // 2. Migration des donn√©es User existantes
    await prisma.$executeRaw`
      UPDATE "users" SET 
        "adultsCount" = GREATEST(1, "familySize" - "childrenCount"),
        "dietaryRestrictions" = CASE 
          WHEN "kosherLevel" != 'none' AND "kosherLevel" IS NOT NULL THEN ARRAY['kosher']::TEXT[]
          ELSE ARRAY[]::TEXT[]
        END,
        "allergens" = COALESCE("allergies", ARRAY[]::TEXT[]),
        "excludedIngredients" = ARRAY['tofu']::TEXT[],
        "includeChildMeals" = CASE WHEN "childrenCount" > 0 THEN true ELSE false END
    `;
    
    console.log("  ‚úÖ Donn√©es utilisateur migr√©es");
    
    // 3. Extension des autres mod√®les
    await prisma.$executeRaw`ALTER TABLE "categories" ADD COLUMN IF NOT EXISTS "icon" TEXT`;
    await prisma.$executeRaw`ALTER TABLE "categories" ADD COLUMN IF NOT EXISTS "color" TEXT`;
    
    // Ingredients
    await prisma.$executeRaw`ALTER TABLE "ingredients" ADD COLUMN IF NOT EXISTS "caloriesPer100g" DOUBLE PRECISION`;
    await prisma.$executeRaw`ALTER TABLE "ingredients" ADD COLUMN IF NOT EXISTS "proteinPer100g" DOUBLE PRECISION`;
    await prisma.$executeRaw`ALTER TABLE "ingredients" ADD COLUMN IF NOT EXISTS "carbsPer100g" DOUBLE PRECISION`;
    await prisma.$executeRaw`ALTER TABLE "ingredients" ADD COLUMN IF NOT EXISTS "fatPer100g" DOUBLE PRECISION`;
    await prisma.$executeRaw`ALTER TABLE "ingredients" ADD COLUMN IF NOT EXISTS "dietaryTags" TEXT[] DEFAULT ARRAY[]::TEXT[]`;
    await prisma.$executeRaw`ALTER TABLE "ingredients" ADD COLUMN IF NOT EXISTS "allergens" TEXT[] DEFAULT ARRAY[]::TEXT[]`;
    await prisma.$executeRaw`ALTER TABLE "ingredients" ADD COLUMN IF NOT EXISTS "seasonality" TEXT[] DEFAULT ARRAY['year_round']::TEXT[]`;
    await prisma.$executeRaw`ALTER TABLE "ingredients" ADD COLUMN IF NOT EXISTS "averageCost" TEXT DEFAULT 'medium'`;
    await prisma.$executeRaw`ALTER TABLE "ingredients" ADD COLUMN IF NOT EXISTS "shelfLife" INTEGER`;
    
    console.log("  ‚úÖ Colonnes ingr√©dients ajout√©es");
    
    // Recipes
    await prisma.$executeRaw`ALTER TABLE "recipes" ADD COLUMN IF NOT EXISTS "imageUrl" TEXT`;
    await prisma.$executeRaw`ALTER TABLE "recipes" ADD COLUMN IF NOT EXISTS "totalTime" INTEGER`;
    await prisma.$executeRaw`ALTER TABLE "recipes" ADD COLUMN IF NOT EXISTS "audience" TEXT DEFAULT 'both'`;
    await prisma.$executeRaw`ALTER TABLE "recipes" ADD COLUMN IF NOT EXISTS "cuisine" TEXT`;
    await prisma.$executeRaw`ALTER TABLE "recipes" ADD COLUMN IF NOT EXISTS "caloriesPerServing" DOUBLE PRECISION`;
    await prisma.$executeRaw`ALTER TABLE "recipes" ADD COLUMN IF NOT EXISTS "proteinPerServing" DOUBLE PRECISION`;
    await prisma.$executeRaw`ALTER TABLE "recipes" ADD COLUMN IF NOT EXISTS "carbsPerServing" DOUBLE PRECISION`;
    await prisma.$executeRaw`ALTER TABLE "recipes" ADD COLUMN IF NOT EXISTS "fatPerServing" DOUBLE PRECISION`;
    await prisma.$executeRaw`ALTER TABLE "recipes" ADD COLUMN IF NOT EXISTS "dietaryTags" TEXT[] DEFAULT ARRAY[]::TEXT[]`;
    await prisma.$executeRaw`ALTER TABLE "recipes" ADD COLUMN IF NOT EXISTS "mealTags" TEXT[] DEFAULT ARRAY[]::TEXT[]`;
    await prisma.$executeRaw`ALTER TABLE "recipes" ADD COLUMN IF NOT EXISTS "occasionTags" TEXT[] DEFAULT ARRAY[]::TEXT[]`;
    await prisma.$executeRaw`ALTER TABLE "recipes" ADD COLUMN IF NOT EXISTS "allergens" TEXT[] DEFAULT ARRAY[]::TEXT[]`;
    await prisma.$executeRaw`ALTER TABLE "recipes" ADD COLUMN IF NOT EXISTS "equipment" TEXT[] DEFAULT ARRAY[]::TEXT[]`;
    await prisma.$executeRaw`ALTER TABLE "recipes" ADD COLUMN IF NOT EXISTS "suggestedSides" TEXT[] DEFAULT ARRAY[]::TEXT[]`;
    await prisma.$executeRaw`ALTER TABLE "recipes" ADD COLUMN IF NOT EXISTS "personalNotes" TEXT`;
    await prisma.$executeRaw`ALTER TABLE "recipes" ADD COLUMN IF NOT EXISTS "isTested" BOOLEAN DEFAULT false`;
    await prisma.$executeRaw`ALTER TABLE "recipes" ADD COLUMN IF NOT EXISTS "isBookmarked" BOOLEAN DEFAULT false`;
    await prisma.$executeRaw`ALTER TABLE "recipes" ADD COLUMN IF NOT EXISTS "lastMade" TIMESTAMP(3)`;
    await prisma.$executeRaw`ALTER TABLE "recipes" ADD COLUMN IF NOT EXISTS "timesCooked" INTEGER DEFAULT 0`;
    await prisma.$executeRaw`ALTER TABLE "recipes" ADD COLUMN IF NOT EXISTS "canMakeAhead" BOOLEAN DEFAULT false`;
    await prisma.$executeRaw`ALTER TABLE "recipes" ADD COLUMN IF NOT EXISTS "freezable" BOOLEAN DEFAULT false`;
    await prisma.$executeRaw`ALTER TABLE "recipes" ADD COLUMN IF NOT EXISTS "leftoverDays" INTEGER`;
    
    console.log("  ‚úÖ Colonnes recettes ajout√©es");
    
    // Meals - ajouter audience avec valeur par d√©faut
    await prisma.$executeRaw`ALTER TABLE "meals" ADD COLUMN IF NOT EXISTS "audience" TEXT DEFAULT 'both'`;
    await prisma.$executeRaw`ALTER TABLE "meals" ADD COLUMN IF NOT EXISTS "isPlanned" BOOLEAN DEFAULT true`;
    await prisma.$executeRaw`ALTER TABLE "meals" ADD COLUMN IF NOT EXISTS "isCooked" BOOLEAN DEFAULT false`;
    await prisma.$executeRaw`ALTER TABLE "meals" ADD COLUMN IF NOT EXISTS "rating" INTEGER`;
    await prisma.$executeRaw`ALTER TABLE "meals" ADD COLUMN IF NOT EXISTS "leftoverPortions" INTEGER DEFAULT 0`;
    await prisma.$executeRaw`ALTER TABLE "meals" ADD COLUMN IF NOT EXISTS "servingsActual" INTEGER`;
    await prisma.$executeRaw`ALTER TABLE "meals" ADD COLUMN IF NOT EXISTS "difficulty" TEXT`;
    await prisma.$executeRaw`ALTER TABLE "meals" ADD COLUMN IF NOT EXISTS "timeActual" INTEGER`;
    
    console.log("  ‚úÖ Colonnes repas ajout√©es");
    
    // √âtape 2: Migration des donn√©es existantes
    console.log("üìù √âtape 2: Migration des donn√©es existantes...");
    
    // Migration des donn√©es meals
    await prisma.$executeRaw`
      UPDATE "meals" SET 
        "audience" = CASE 
          WHEN "mealType" LIKE '%children%' THEN 'children'
          WHEN "mealType" LIKE '%adults%' THEN 'adults'
          ELSE 'both'
        END
      WHERE "audience" = 'both'
    `;
    
    // Mise √† jour des mealType pour le nouveau format
    await prisma.$executeRaw`
      UPDATE "meals" SET 
        "mealType" = CASE 
          WHEN "mealType" LIKE '%lunch%' THEN 'lunch'
          WHEN "mealType" LIKE '%dinner%' THEN 'dinner'
          ELSE 'dinner'
        END
    `;
    
    // Migration des donn√©es recipes
    await prisma.$executeRaw`
      UPDATE "recipes" SET 
        "audience" = CASE 
          WHEN "mealType" LIKE '%children%' THEN 'children'
          WHEN "mealType" LIKE '%adults%' THEN 'adults'
          ELSE 'both'
        END,
        "totalTime" = COALESCE("prepTime", 0) + COALESCE("cookTime", 0),
        "dietaryTags" = CASE 
          WHEN "isKosher" = true THEN ARRAY['kosher']::TEXT[]
          ELSE ARRAY[]::TEXT[]
        END,
        "equipment" = COALESCE("ustensils", ARRAY[]::TEXT[]),
        "occasionTags" = COALESCE("tags", ARRAY[]::TEXT[])
      WHERE "audience" = 'both' OR "totalTime" IS NULL
    `;
    
    // Mise √† jour des mealType pour les recettes
    await prisma.$executeRaw`
      UPDATE "recipes" SET 
        "mealType" = CASE 
          WHEN "mealType" LIKE '%lunch%' THEN 'lunch'
          WHEN "mealType" LIKE '%dinner%' THEN 'dinner'
          ELSE 'dinner'
        END
    `;
    
    console.log("  ‚úÖ Donn√©es migr√©es");
    
    // √âtape 3: Cr√©er des pr√©f√©rences par d√©faut pour les utilisateurs existants
    console.log("üìù √âtape 3: Cr√©ation des pr√©f√©rences par d√©faut...");
    
    // Nous cr√©erons les tables via Prisma dans la prochaine √©tape
    
    console.log("‚úÖ Migration de base termin√©e avec succ√®s !");
    console.log("üîÑ Red√©marrer l'application pour appliquer le nouveau sch√©ma...");
    
  } catch (error) {
    console.error("‚ùå Erreur durant la migration:", error);
    throw error;
  } finally {
    await prisma.$disconnect();
  }
}

// Ex√©cuter la migration
if (require.main === module) {
  applyEnhancedMigration()
    .then(() => {
      console.log("üéâ Migration appliqu√©e avec succ√®s !");
      process.exit(0);
    })
    .catch((error) => {
      console.error("üí• √âchec de la migration:", error);
      process.exit(1);
    });
}

module.exports = { applyEnhancedMigration };