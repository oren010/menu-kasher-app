<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API - Administration Menu Kasher</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/admin.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">Test des APIs d'Administration</h1>
                
                <!-- Login Admin -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>1. Connexion Admin</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-4">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="adminEmail" value="admin@menu-kasher.app">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Mot de passe</label>
                                <input type="password" class="form-control" id="adminPassword" value="Admin123!">
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-primary" onclick="testAdminLogin()">
                                    <i class="bi bi-box-arrow-in-right me-2"></i>
                                    Se connecter
                                </button>
                            </div>
                        </div>
                        <div id="loginResult" class="mt-3"></div>
                    </div>
                </div>

                <!-- Test APIs -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>2. Tests des APIs</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <button class="btn btn-outline-primary w-100" onclick="testUsersStats()">
                                    <i class="bi bi-graph-up me-2"></i>
                                    Stats Utilisateurs
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-success w-100" onclick="testUsersList()">
                                    <i class="bi bi-people me-2"></i>
                                    Liste Utilisateurs
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-info w-100" onclick="testGlobalStats()">
                                    <i class="bi bi-bar-chart me-2"></i>
                                    Stats Globales
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-warning w-100" onclick="testUserDetail()">
                                    <i class="bi bi-person me-2"></i>
                                    D√©tail Utilisateur
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- R√©sultats -->
                <div class="card">
                    <div class="card-header">
                        <h5>3. R√©sultats des Tests</h5>
                    </div>
                    <div class="card-body">
                        <pre id="testResults" class="bg-light p-3" style="height: 400px; overflow-y: auto; font-size: 12px;"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/admin.js"></script>
    <script>
        let authToken = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const results = document.getElementById('testResults');
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            results.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            results.scrollTop = results.scrollHeight;
        }

        async function testAdminLogin() {
            try {
                log('üîÑ Test de connexion admin...');
                
                const email = document.getElementById('adminEmail').value;
                const password = document.getElementById('adminPassword').value;
                
                const response = await fetch('/api/auth/admin/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    authToken = data.accessToken;
                    log('Connexion admin r√©ussie!', 'success');
                    log(`Token re√ßu: ${authToken.substring(0, 50)}...`);
                    
                    document.getElementById('loginResult').innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i>
                            Connect√© en tant que: <strong>${data.admin.name}</strong> (${data.admin.role})
                        </div>
                    `;
                } else {
                    throw new Error(data.message || 'Erreur inconnue');
                }
                
            } catch (error) {
                log(`Erreur de connexion: ${error.message}`, 'error');
                document.getElementById('loginResult').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle me-2"></i>
                        Erreur: ${error.message}
                    </div>
                `;
            }
        }

        async function testUsersStats() {
            if (!authToken) {
                log('‚ö†Ô∏è Veuillez vous connecter d\'abord', 'error');
                return;
            }
            
            try {
                log('üîÑ Test des statistiques utilisateurs...');
                
                const response = await fetch('/api/users/stats/overview', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('Statistiques utilisateurs r√©cup√©r√©es!', 'success');
                    log(`Total: ${data.stats.totalUsers}, Actifs: ${data.stats.activeUsers}, Nouveaux: ${data.stats.newUsersThisWeek}`);
                } else {
                    throw new Error(data.message);
                }
                
            } catch (error) {
                log(`Erreur stats utilisateurs: ${error.message}`, 'error');
            }
        }

        async function testUsersList() {
            if (!authToken) {
                log('‚ö†Ô∏è Veuillez vous connecter d\'abord', 'error');
                return;
            }
            
            try {
                log('üîÑ Test de la liste des utilisateurs...');
                
                const response = await fetch('/api/users', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('Liste des utilisateurs r√©cup√©r√©e!', 'success');
                    log(`${data.users.length} utilisateurs trouv√©s`);
                    data.users.forEach(user => {
                        log(`- ${user.name} (${user.email}) - ${user.isActive ? 'Actif' : 'Inactif'}`);
                    });
                } else {
                    throw new Error(data.message);
                }
                
            } catch (error) {
                log(`Erreur liste utilisateurs: ${error.message}`, 'error');
            }
        }

        async function testGlobalStats() {
            if (!authToken) {
                log('‚ö†Ô∏è Veuillez vous connecter d\'abord', 'error');
                return;
            }
            
            try {
                log('üîÑ Test des statistiques globales...');
                
                const response = await fetch('/api/stats', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                
                log('Statistiques globales r√©cup√©r√©es!', 'success');
                log(`Recettes: ${data.recipes}, Menus: ${data.menus}, Ingr√©dients: ${data.ingredients}`);
                
            } catch (error) {
                log(`Erreur stats globales: ${error.message}`, 'error');
            }
        }

        async function testUserDetail() {
            if (!authToken) {
                log('‚ö†Ô∏è Veuillez vous connecter d\'abord', 'error');
                return;
            }
            
            try {
                log('üîÑ Test du d√©tail utilisateur...');
                
                // D'abord r√©cup√©rer la liste pour avoir un ID
                const listResponse = await fetch('/api/users', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const listData = await listResponse.json();
                
                if (listData.success && listData.users.length > 0) {
                    const userId = listData.users[0].id;
                    
                    const response = await fetch(`/api/users/${userId}`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        log('D√©tail utilisateur r√©cup√©r√©!', 'success');
                        log(`Utilisateur: ${data.user.name} - ${data.user.menus.length} menus`);
                    } else {
                        throw new Error(data.message);
                    }
                } else {
                    log('Aucun utilisateur trouv√© pour le test de d√©tail', 'error');
                }
                
            } catch (error) {
                log(`Erreur d√©tail utilisateur: ${error.message}`, 'error');
            }
        }

        // Auto-login au chargement pour les tests
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Page de test des APIs charg√©e');
            log('Cliquez sur "Se connecter" puis testez les diff√©rentes APIs');
        });
    </script>
</body>
</html>