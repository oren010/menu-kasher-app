<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Utilisateurs - Administration Menu Kasher</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/admin.css" rel="stylesheet">
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar sera chargée dynamiquement -->
        
        <div class="admin-content">
            <!-- Header sera chargé dynamiquement -->
            
            <main class="admin-main">
                <div class="page-header fade-in">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="page-title">
                                <i class="bi bi-people me-2"></i>
                                Gestion des Utilisateurs
                            </h1>
                            <p class="page-subtitle">Gérez les comptes utilisateurs de votre plateforme</p>
                        </div>
                        <div>
                            <button class="btn btn-primary" onclick="showCreateUserModal()">
                                <i class="bi bi-person-plus me-2"></i>
                                Créer un utilisateur
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Statistiques utilisateurs -->
                <div class="row g-4 mb-4 fade-in">
                    <div class="col-xl-3 col-md-6">
                        <div class="widget">
                            <div class="widget-header">
                                <h3 class="widget-title">Total utilisateurs</h3>
                                <div class="widget-icon primary">
                                    <i class="bi bi-people"></i>
                                </div>
                            </div>
                            <div class="widget-value" id="totalUsersCount">-</div>
                            <p class="widget-label">Comptes créés</p>
                        </div>
                    </div>

                    <div class="col-xl-3 col-md-6">
                        <div class="widget">
                            <div class="widget-header">
                                <h3 class="widget-title">Utilisateurs actifs</h3>
                                <div class="widget-icon success">
                                    <i class="bi bi-person-check"></i>
                                </div>
                            </div>
                            <div class="widget-value" id="activeUsersCount">-</div>
                            <p class="widget-label">Comptes actifs</p>
                        </div>
                    </div>

                    <div class="col-xl-3 col-md-6">
                        <div class="widget">
                            <div class="widget-header">
                                <h3 class="widget-title">Nouveaux cette semaine</h3>
                                <div class="widget-icon info">
                                    <i class="bi bi-person-plus"></i>
                                </div>
                            </div>
                            <div class="widget-value" id="newUsersCount">-</div>
                            <p class="widget-label">Inscriptions récentes</p>
                        </div>
                    </div>

                    <div class="col-xl-3 col-md-6">
                        <div class="widget">
                            <div class="widget-header">
                                <h3 class="widget-title">Connectés aujourd'hui</h3>
                                <div class="widget-icon warning">
                                    <i class="bi bi-activity"></i>
                                </div>
                            </div>
                            <div class="widget-value" id="todayActiveCount">-</div>
                            <p class="widget-label">Sessions actives</p>
                        </div>
                    </div>
                </div>

                <!-- Filtres et recherche -->
                <div class="card mb-4 fade-in">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-search"></i>
                                    </span>
                                    <input type="text" class="form-control" id="searchUsers" placeholder="Rechercher par nom ou email...">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filterStatus">
                                    <option value="">Tous les statuts</option>
                                    <option value="active">Actifs</option>
                                    <option value="inactive">Inactifs</option>
                                    <option value="new">Nouveaux (7 jours)</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="sortBy">
                                    <option value="name">Trier par nom</option>
                                    <option value="email">Trier par email</option>
                                    <option value="created">Trier par date de création</option>
                                    <option value="lastLogin">Trier par dernière connexion</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                                    <i class="bi bi-arrow-clockwise"></i>
                                    Reset
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Liste des utilisateurs -->
                <div class="card fade-in">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-table me-2"></i>
                            Liste des utilisateurs
                        </h5>
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge bg-primary" id="userCount">0 utilisateurs</span>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="exportUsers('csv')">
                                        <i class="bi bi-file-earmark-csv me-2"></i>Exporter CSV
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportUsers('excel')">
                                        <i class="bi bi-file-earmark-excel me-2"></i>Exporter Excel
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" onclick="bulkActivate()">
                                        <i class="bi bi-check-all me-2"></i>Activer sélectionnés
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="bulkDeactivate()">
                                        <i class="bi bi-x-circle me-2"></i>Désactiver sélectionnés
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th width="40">
                                            <input type="checkbox" class="form-check-input" id="selectAll">
                                        </th>
                                        <th>Utilisateur</th>
                                        <th>Statut</th>
                                        <th>Famille</th>
                                        <th>Allergènes</th>
                                        <th>Inscrit le</th>
                                        <th>Dernière connexion</th>
                                        <th width="120">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <tr>
                                        <td colspan="8" class="text-center py-4">
                                            <div class="loading">
                                                <div class="spinner"></div>
                                                <span>Chargement des utilisateurs...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-4 fade-in">
                    <div class="text-muted">
                        Affichage de <span id="paginationInfo">1-10 sur 25</span> utilisateurs
                    </div>
                    <nav>
                        <ul class="pagination mb-0" id="pagination">
                            <!-- Pagination générée dynamiquement -->
                        </ul>
                    </nav>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal Création/Édition utilisateur -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalTitle">
                        <i class="bi bi-person-plus me-2"></i>
                        Créer un utilisateur
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="userForm">
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="userName" class="form-label">Nom complet *</label>
                                <input type="text" class="form-control" id="userName" name="name" required>
                            </div>
                            <div class="col-md-6">
                                <label for="userEmail" class="form-label">Adresse email *</label>
                                <input type="email" class="form-control" id="userEmail" name="email" required>
                            </div>
                            <div class="col-md-6">
                                <label for="userPassword" class="form-label">Mot de passe *</label>
                                <input type="password" class="form-control" id="userPassword" name="password" required>
                                <div class="form-text">Minimum 8 caractères, avec majuscule, minuscule et chiffre</div>
                            </div>
                            <div class="col-md-6">
                                <label for="userPasswordConfirm" class="form-label">Confirmer le mot de passe *</label>
                                <input type="password" class="form-control" id="userPasswordConfirm" name="passwordConfirm" required>
                            </div>
                            <div class="col-md-3">
                                <label for="adultsCount" class="form-label">Nombre d'adultes</label>
                                <input type="number" class="form-control" id="adultsCount" name="adultsCount" min="1" max="10" value="2">
                            </div>
                            <div class="col-md-3">
                                <label for="childrenCount" class="form-label">Nombre d'enfants</label>
                                <input type="number" class="form-control" id="childrenCount" name="childrenCount" min="0" max="10" value="1">
                            </div>
                            <div class="col-md-6">
                                <label for="userAllergens" class="form-label">Allergènes (optionnel)</label>
                                <select class="form-select" id="userAllergens" name="allergens" multiple>
                                    <option value="nuts">Fruits à coque</option>
                                    <option value="gluten">Gluten</option>
                                    <option value="dairy">Produits laitiers</option>
                                    <option value="eggs">Œufs</option>
                                    <option value="fish">Poisson</option>
                                    <option value="shellfish">Fruits de mer</option>
                                    <option value="soy">Soja</option>
                                    <option value="sesame">Sésame</option>
                                </select>
                                <div class="form-text">Maintenez Ctrl (Cmd sur Mac) pour sélectionner plusieurs options</div>
                            </div>
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="userActive" name="isActive" checked>
                                    <label class="form-check-label" for="userActive">
                                        Compte actif
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-primary" id="saveUserBtn">
                            <i class="bi bi-check-lg me-2"></i>
                            Créer l'utilisateur
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Détails utilisateur -->
    <div class="modal fade" id="userDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-person-circle me-2"></i>
                        Détails de l'utilisateur
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="userDetailsContent">
                    <!-- Contenu chargé dynamiquement -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    <button type="button" class="btn btn-primary" onclick="editUserFromDetails()">
                        <i class="bi bi-pencil me-2"></i>
                        Modifier
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/admin.js"></script>
    <script>
        // Variables globales
        let users = [];
        let filteredUsers = [];
        let currentPage = 1;
        let usersPerPage = 10;
        let currentEditingUser = null;

        // Initialisation
        document.addEventListener('DOMContentLoaded', async function() {
            await initUsersPage();
        });

        async function initUsersPage() {
            try {
                // Charger les données en parallèle
                await Promise.all([
                    loadUsers(),
                    loadStatistics()
                ]);
                
                // Configurer les événements
                setupEventListeners();
                
                // Mettre à jour l'affichage
                updateUsersList();
                
            } catch (error) {
                console.error('Erreur lors de l\'initialisation:', error);
                AdminApp.Utils.toast('Erreur lors du chargement des utilisateurs', 'danger');
            }
        }

        async function loadUsers() {
            try {
                const response = await AdminApp.Utils.api.get('/users');
                users = response.users || [];
                filteredUsers = [...users];
                
            } catch (error) {
                console.error('Erreur lors du chargement des utilisateurs:', error);
                // Données factices pour la démonstration
                users = [
                    {
                        id: '1',
                        name: 'Famille Cohen',
                        email: 'famille@menu-kasher.app',
                        isActive: true,
                        adultsCount: 2,
                        childrenCount: 1,
                        allergens: ['nuts'],
                        createdAt: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000),
                        lastLogin: new Date(Date.now() - 2 * 60 * 60 * 1000)
                    },
                    {
                        id: '2',
                        name: 'Utilisateur Test',
                        email: 'test@menu-kasher.com',
                        isActive: true,
                        adultsCount: 2,
                        childrenCount: 1,
                        allergens: ['nuts'],
                        createdAt: new Date(),
                        lastLogin: new Date()
                    }
                ];
                filteredUsers = [...users];
            }
        }

        async function loadStatistics() {
            try {
                const response = await AdminApp.Utils.api.get('/users/stats/overview');
                const stats = response.stats;
                
                document.getElementById('totalUsersCount').textContent = AdminApp.Utils.formatNumber(stats.totalUsers);
                document.getElementById('activeUsersCount').textContent = AdminApp.Utils.formatNumber(stats.activeUsers);
                document.getElementById('newUsersCount').textContent = AdminApp.Utils.formatNumber(stats.newUsersThisWeek);
                document.getElementById('todayActiveCount').textContent = AdminApp.Utils.formatNumber(stats.usersLoggedInToday);
                
            } catch (error) {
                console.error('Erreur lors du chargement des statistiques:', error);
                // Fallback to client-side calculation
                updateStatistics();
            }
        }

        function setupEventListeners() {
            // Recherche
            document.getElementById('searchUsers').addEventListener('input', AdminApp.Utils.debounce(filterUsers, 300));
            
            // Filtres
            document.getElementById('filterStatus').addEventListener('change', filterUsers);
            document.getElementById('sortBy').addEventListener('change', sortUsers);
            
            // Sélection multiple
            document.getElementById('selectAll').addEventListener('change', toggleSelectAll);
            
            // Formulaire utilisateur
            document.getElementById('userForm').addEventListener('submit', handleUserSubmit);
        }

        function updateStatistics() {
            const totalUsers = users.length;
            const activeUsers = users.filter(u => u.isActive).length;
            const newUsers = users.filter(u => {
                const created = new Date(u.createdAt);
                const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                return created > weekAgo;
            }).length;
            const todayActive = users.filter(u => {
                if (!u.lastLogin) return false;
                const login = new Date(u.lastLogin);
                const today = new Date();
                return login.toDateString() === today.toDateString();
            }).length;

            document.getElementById('totalUsersCount').textContent = AdminApp.Utils.formatNumber(totalUsers);
            document.getElementById('activeUsersCount').textContent = AdminApp.Utils.formatNumber(activeUsers);
            document.getElementById('newUsersCount').textContent = AdminApp.Utils.formatNumber(newUsers);
            document.getElementById('todayActiveCount').textContent = AdminApp.Utils.formatNumber(todayActive);
        }

        function updateUsersList() {
            const tbody = document.getElementById('usersTableBody');
            const start = (currentPage - 1) * usersPerPage;
            const end = start + usersPerPage;
            const pageUsers = filteredUsers.slice(start, end);

            if (pageUsers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4 text-muted">
                            <i class="bi bi-person-x fs-1"></i>
                            <div class="mt-2">Aucun utilisateur trouvé</div>
                        </td>
                    </tr>
                `;
                document.getElementById('userCount').textContent = '0 utilisateurs';
                return;
            }

            tbody.innerHTML = pageUsers.map(user => `
                <tr>
                    <td>
                        <input type="checkbox" class="form-check-input user-checkbox" value="${user.id}">
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 36px; height: 36px;">
                                <i class="bi bi-person-fill text-white"></i>
                            </div>
                            <div>
                                <div class="fw-semibold">${user.name}</div>
                                <div class="small text-muted">${user.email}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-${user.isActive ? 'success' : 'secondary'}">
                            <i class="bi bi-${user.isActive ? 'check-circle' : 'x-circle'} me-1"></i>
                            ${user.isActive ? 'Actif' : 'Inactif'}
                        </span>
                    </td>
                    <td>
                        <i class="bi bi-people me-1"></i>
                        ${user.adultsCount} adultes, ${user.childrenCount} enfants
                    </td>
                    <td>
                        ${user.allergens && user.allergens.length > 0 
                            ? user.allergens.map(a => `<span class="badge bg-warning text-dark me-1">${a}</span>`).join('')
                            : '<span class="text-muted">Aucun</span>'
                        }
                    </td>
                    <td>
                        <small>${AdminApp.Utils.formatDate(user.createdAt, { year: 'numeric', month: 'short', day: 'numeric' })}</small>
                    </td>
                    <td>
                        <small>${user.lastLogin 
                            ? AdminApp.Utils.formatDate(user.lastLogin, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })
                            : 'Jamais'
                        }</small>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="window.location.href='user-detail.html?id=${user.id}'" title="Voir les détails">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-outline-secondary" onclick="editUser('${user.id}')" title="Modifier">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-${user.isActive ? 'warning' : 'success'}" onclick="toggleUserStatus('${user.id}')" title="${user.isActive ? 'Désactiver' : 'Activer'}">
                                <i class="bi bi-${user.isActive ? 'pause' : 'play'}"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            // Mettre à jour le compteur
            document.getElementById('userCount').textContent = `${AdminApp.Utils.formatNumber(filteredUsers.length)} utilisateur${filteredUsers.length > 1 ? 's' : ''}`;
            
            // Mettre à jour la pagination
            updatePagination();
        }

        function filterUsers() {
            const search = document.getElementById('searchUsers').value.toLowerCase();
            const status = document.getElementById('filterStatus').value;

            filteredUsers = users.filter(user => {
                // Filtre de recherche
                if (search && !user.name.toLowerCase().includes(search) && !user.email.toLowerCase().includes(search)) {
                    return false;
                }

                // Filtre de statut
                if (status) {
                    switch (status) {
                        case 'active':
                            return user.isActive;
                        case 'inactive':
                            return !user.isActive;
                        case 'new':
                            const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                            return new Date(user.createdAt) > weekAgo;
                    }
                }

                return true;
            });

            currentPage = 1;
            updateUsersList();
        }

        function sortUsers() {
            const sortBy = document.getElementById('sortBy').value;

            filteredUsers.sort((a, b) => {
                switch (sortBy) {
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'email':
                        return a.email.localeCompare(b.email);
                    case 'created':
                        return new Date(b.createdAt) - new Date(a.createdAt);
                    case 'lastLogin':
                        return new Date(b.lastLogin || 0) - new Date(a.lastLogin || 0);
                    default:
                        return 0;
                }
            });

            updateUsersList();
        }

        function resetFilters() {
            document.getElementById('searchUsers').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('sortBy').value = 'name';
            
            filteredUsers = [...users];
            currentPage = 1;
            updateUsersList();
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
            const pagination = document.getElementById('pagination');
            const start = (currentPage - 1) * usersPerPage + 1;
            const end = Math.min(currentPage * usersPerPage, filteredUsers.length);

            // Mettre à jour les informations de pagination
            document.getElementById('paginationInfo').textContent = `${start}-${end} sur ${filteredUsers.length}`;

            // Générer les boutons de pagination
            let paginationHTML = '';
            
            // Bouton précédent
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>
            `;

            // Numéros de page
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `;
            }

            // Bouton suivant
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            `;

            pagination.innerHTML = paginationHTML;
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            updateUsersList();
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.user-checkbox');
            
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        }

        function showCreateUserModal() {
            currentEditingUser = null;
            document.getElementById('userModalTitle').innerHTML = '<i class="bi bi-person-plus me-2"></i>Créer un utilisateur';
            document.getElementById('saveUserBtn').innerHTML = '<i class="bi bi-check-lg me-2"></i>Créer l\'utilisateur';
            document.getElementById('userForm').reset();
            document.getElementById('adultsCount').value = '2';
            document.getElementById('childrenCount').value = '1';
            document.getElementById('userActive').checked = true;
            
            const modal = new bootstrap.Modal(document.getElementById('userModal'));
            modal.show();
        }

        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            currentEditingUser = user;
            document.getElementById('userModalTitle').innerHTML = '<i class="bi bi-pencil me-2"></i>Modifier l\'utilisateur';
            document.getElementById('saveUserBtn').innerHTML = '<i class="bi bi-check-lg me-2"></i>Sauvegarder';
            
            // Remplir le formulaire
            document.getElementById('userName').value = user.name;
            document.getElementById('userEmail').value = user.email;
            document.getElementById('adultsCount').value = user.adultsCount;
            document.getElementById('childrenCount').value = user.childrenCount;
            document.getElementById('userActive').checked = user.isActive;
            
            // Mots de passe non requis pour la modification
            document.getElementById('userPassword').required = false;
            document.getElementById('userPasswordConfirm').required = false;
            
            // Sélectionner les allergènes
            const allergensSelect = document.getElementById('userAllergens');
            Array.from(allergensSelect.options).forEach(option => {
                option.selected = user.allergens && user.allergens.includes(option.value);
            });

            const modal = new bootstrap.Modal(document.getElementById('userModal'));
            modal.show();
        }

        async function handleUserSubmit(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const userData = {
                name: formData.get('name').trim(),
                email: formData.get('email').trim().toLowerCase(),
                adultsCount: parseInt(formData.get('adultsCount')),
                childrenCount: parseInt(formData.get('childrenCount')),
                isActive: formData.get('isActive') === 'on',
                allergens: Array.from(document.getElementById('userAllergens').selectedOptions).map(o => o.value)
            };

            // Validation des mots de passe pour création
            if (!currentEditingUser) {
                const password = formData.get('password');
                const passwordConfirm = formData.get('passwordConfirm');
                
                if (!password || password.length < 8) {
                    AdminApp.Utils.toast('Le mot de passe doit contenir au moins 8 caractères', 'warning');
                    return;
                }
                
                if (password !== passwordConfirm) {
                    AdminApp.Utils.toast('Les mots de passe ne correspondent pas', 'warning');
                    return;
                }
                
                userData.password = password;
            } else if (formData.get('password')) {
                // Modification avec nouveau mot de passe
                const password = formData.get('password');
                const passwordConfirm = formData.get('passwordConfirm');
                
                if (password !== passwordConfirm) {
                    AdminApp.Utils.toast('Les mots de passe ne correspondent pas', 'warning');
                    return;
                }
                
                userData.password = password;
            }

            try {
                let response;
                if (currentEditingUser) {
                    // Modification
                    response = await AdminApp.Utils.api.put(`/users/${currentEditingUser.id}`, userData);
                    AdminApp.Utils.toast('Utilisateur modifié avec succès', 'success');
                } else {
                    // Création
                    response = await AdminApp.Utils.api.post('/auth/register', userData);
                    AdminApp.Utils.toast('Utilisateur créé avec succès', 'success');
                }
                
                // Recharger les utilisateurs
                await loadUsers();
                updateUsersList();
                updateStatistics();
                
                // Fermer le modal
                bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
                
            } catch (error) {
                console.error('Erreur lors de la sauvegarde:', error);
                AdminApp.Utils.toast(error.message || 'Erreur lors de la sauvegarde', 'danger');
            }
        }

        async function toggleUserStatus(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            try {
                await AdminApp.Utils.api.put(`/users/${userId}`, {
                    isActive: !user.isActive
                });
                
                user.isActive = !user.isActive;
                updateUsersList();
                updateStatistics();
                
                AdminApp.Utils.toast(`Utilisateur ${user.isActive ? 'activé' : 'désactivé'}`, 'success');
                
            } catch (error) {
                console.error('Erreur lors du changement de statut:', error);
                AdminApp.Utils.toast('Erreur lors du changement de statut', 'danger');
            }
        }

        function showUserDetails(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            const content = document.getElementById('userDetailsContent');
            content.innerHTML = `
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-person-circle me-2"></i>Informations personnelles</h6>
                            </div>
                            <div class="card-body">
                                <dl class="row mb-0">
                                    <dt class="col-sm-4">Nom :</dt>
                                    <dd class="col-sm-8">${user.name}</dd>
                                    <dt class="col-sm-4">Email :</dt>
                                    <dd class="col-sm-8">${user.email}</dd>
                                    <dt class="col-sm-4">Statut :</dt>
                                    <dd class="col-sm-8">
                                        <span class="badge bg-${user.isActive ? 'success' : 'secondary'}">
                                            ${user.isActive ? 'Actif' : 'Inactif'}
                                        </span>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-house me-2"></i>Composition familiale</h6>
                            </div>
                            <div class="card-body">
                                <dl class="row mb-0">
                                    <dt class="col-sm-6">Adultes :</dt>
                                    <dd class="col-sm-6">${user.adultsCount}</dd>
                                    <dt class="col-sm-6">Enfants :</dt>
                                    <dd class="col-sm-6">${user.childrenCount}</dd>
                                    <dt class="col-sm-6">Allergènes :</dt>
                                    <dd class="col-sm-6">
                                        ${user.allergens && user.allergens.length > 0 
                                            ? user.allergens.map(a => `<span class="badge bg-warning text-dark me-1">${a}</span>`).join('')
                                            : '<span class="text-muted">Aucun</span>'
                                        }
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-clock-history me-2"></i>Historique</h6>
                            </div>
                            <div class="card-body">
                                <dl class="row mb-0">
                                    <dt class="col-sm-3">Inscrit le :</dt>
                                    <dd class="col-sm-3">${AdminApp.Utils.formatDate(user.createdAt)}</dd>
                                    <dt class="col-sm-3">Dernière connexion :</dt>
                                    <dd class="col-sm-3">${user.lastLogin ? AdminApp.Utils.formatDate(user.lastLogin) : 'Jamais'}</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
            modal.show();
        }

        function editUserFromDetails() {
            // Fermer le modal de détails et ouvrir celui d'édition
            bootstrap.Modal.getInstance(document.getElementById('userDetailsModal')).hide();
            setTimeout(() => {
                const userId = currentEditingUser?.id || users[0]?.id; // Récupérer l'ID du dernier utilisateur consulté
                editUser(userId);
            }, 300);
        }

        function exportUsers(format) {
            AdminApp.Utils.toast(`Export ${format.toUpperCase()} en cours...`, 'info');
            
            // Simuler l'export
            setTimeout(() => {
                AdminApp.Utils.toast(`Utilisateurs exportés au format ${format.toUpperCase()}`, 'success');
            }, 2000);
        }

        function bulkActivate() {
            const selected = Array.from(document.querySelectorAll('.user-checkbox:checked')).map(cb => cb.value);
            if (selected.length === 0) {
                AdminApp.Utils.toast('Aucun utilisateur sélectionné', 'warning');
                return;
            }
            
            AdminApp.Utils.toast(`${selected.length} utilisateurs activés`, 'success');
        }

        function bulkDeactivate() {
            const selected = Array.from(document.querySelectorAll('.user-checkbox:checked')).map(cb => cb.value);
            if (selected.length === 0) {
                AdminApp.Utils.toast('Aucun utilisateur sélectionné', 'warning');
                return;
            }
            
            AdminApp.Utils.toast(`${selected.length} utilisateurs désactivés`, 'success');
        }
    </script>
</body>
</html>